# Module 5: Multi-Level Flag Management

## Overview
This module manages quality control flags at multiple hierarchical levels: snip, image, video, and experiment. Flags indicate various issues or conditions that affect data quality or require attention.

## Core Flag Methods

### Add Flag at Any Level

```python
def add_flag(self, entity_id: str, flag: str, level: str, author: str,
            notes: str = None, severity: str = "warning",
            auto_generated: bool = False) -> bool:
    """
    Add a flag at any level of the hierarchy.
    
    Args:
        entity_id: ID of the entity to flag
        flag: Flag value (must be in permitted values for level)
        level: Level of flag ("snip", "image", "video", "experiment")
        author: Who is adding the flag
        notes: Optional notes about the flag
        severity: Flag severity ("info", "warning", "error")
        auto_generated: Whether flag was auto-generated by system
    
    Returns:
        bool: True if flag was added
    
    Raises:
        ValidationError: If flag not permitted for level
    """
    # Validate level
    if level not in ["snip", "image", "video", "experiment"]:
        raise ValueError(f"Invalid flag level: {level}")
    
    # Validate flag against permitted values
    level_key = f"{level}_level"
    permitted_flags = self.data["permitted_values"]["flags"].get(level_key, {})
    
    if flag not in permitted_flags:
        raise ValidationError(
            f"Flag '{flag}' not permitted for {level} level. "
            f"Allowed: {list(permitted_flags.keys())}"
        )
    
    # Create flag object
    flag_obj = Flag(
        value=flag,
        author=author,
        notes=notes,
        severity=severity,
        auto_generated=auto_generated
    )
    
    # Route to appropriate handler
    if level == "snip":
        return self._add_snip_flag(entity_id, flag_obj)
    elif level == "image":
        return self._add_image_flag(entity_id, flag_obj)
    elif level == "video":
        return self._add_video_flag(entity_id, flag_obj)
    elif level == "experiment":
        return self._add_experiment_flag(entity_id, flag_obj)
```

### Level-Specific Flag Methods

```python
def _add_snip_flag(self, snip_id: str, flag_obj: Flag) -> bool:
    """Add flag to a snip."""
    # Find embryo containing the snip
    embryo_id = self._get_embryo_id_from_snip(snip_id)
    if not embryo_id:
        raise ValueError(f"Snip {snip_id} not found")
    
    snip_data = self.data["embryos"][embryo_id]["snips"][snip_id]
    
    # Initialize flags list if needed
    if "flags" not in snip_data:
        snip_data["flags"] = []
    
    # Check for duplicate flags
    existing_flags = [f["value"] for f in snip_data["flags"]]
    if flag_obj.value in existing_flags:
        if self.verbose:
            print(f"âš ï¸ Flag '{flag_obj.value}' already exists on {snip_id}")
        return False
    
    # Add flag
    snip_data["flags"].append(flag_obj.to_dict())
    
    self._unsaved_changes = True
    self._add_change_log("add_flag", {
        "level": "snip",
        "entity_id": snip_id,
        "flag": flag_obj.value,
        "author": flag_obj.author
    })
    
    if self.verbose:
        print(f"âœ… Added flag '{flag_obj.value}' to snip {snip_id}")
    
    return True

def _add_image_flag(self, image_id: str, flag_obj: Flag) -> bool:
    """Add flag to an image."""
    # Initialize image flags structure if needed
    if "image" not in self.data["flags"]:
        self.data["flags"]["image"] = {}
    
    if image_id not in self.data["flags"]["image"]:
        self.data["flags"]["image"][image_id] = []
    
    # Check for duplicates
    existing_flags = [f["value"] for f in self.data["flags"]["image"][image_id]]
    if flag_obj.value in existing_flags:
        if self.verbose:
            print(f"âš ï¸ Flag '{flag_obj.value}' already exists on image {image_id}")
        return False
    
    # Add flag
    self.data["flags"]["image"][image_id].append(flag_obj.to_dict())
    
    self._unsaved_changes = True
    self._add_change_log("add_flag", {
        "level": "image",
        "entity_id": image_id,
        "flag": flag_obj.value,
        "author": flag_obj.author
    })
    
    if self.verbose:
        print(f"âœ… Added flag '{flag_obj.value}' to image {image_id}")
    
    return True

def _add_video_flag(self, video_id: str, flag_obj: Flag) -> bool:
    """Add flag to a video."""
    if "video" not in self.data["flags"]:
        self.data["flags"]["video"] = {}
    
    if video_id not in self.data["flags"]["video"]:
        self.data["flags"]["video"][video_id] = []
    
    # Check for duplicates
    existing_flags = [f["value"] for f in self.data["flags"]["video"][video_id]]
    if flag_obj.value in existing_flags:
        if self.verbose:
            print(f"âš ï¸ Flag '{flag_obj.value}' already exists on video {video_id}")
        return False
    
    # Add flag
    self.data["flags"]["video"][video_id].append(flag_obj.to_dict())
    
    self._unsaved_changes = True
    self._add_change_log("add_flag", {
        "level": "video",
        "entity_id": video_id,
        "flag": flag_obj.value,
        "author": flag_obj.author
    })
    
    if self.verbose:
        print(f"âœ… Added flag '{flag_obj.value}' to video {video_id}")
    
    return True

def _add_experiment_flag(self, experiment_id: str, flag_obj: Flag) -> bool:
    """Add flag to an experiment."""
    if "experiment" not in self.data["flags"]:
        self.data["flags"]["experiment"] = {}
    
    if experiment_id not in self.data["flags"]["experiment"]:
        self.data["flags"]["experiment"][experiment_id] = []
    
    # Check for duplicates
    existing_flags = [f["value"] for f in self.data["flags"]["experiment"][experiment_id]]
    if flag_obj.value in existing_flags:
        if self.verbose:
            print(f"âš ï¸ Flag '{flag_obj.value}' already exists on experiment {experiment_id}")
        return False
    
    # Add flag
    self.data["flags"]["experiment"][experiment_id].append(flag_obj.to_dict())
    
    self._unsaved_changes = True
    self._add_change_log("add_flag", {
        "level": "experiment",
        "entity_id": experiment_id,
        "flag": flag_obj.value,
        "author": flag_obj.author
    })
    
    if self.verbose:
        print(f"âœ… Added flag '{flag_obj.value}' to experiment {experiment_id}")
    
    return True
```

### Remove Flag

```python
def remove_flag(self, entity_id: str, flag: str, level: str, 
               author: str, reason: str = None) -> bool:
    """
    Remove a flag from an entity.
    
    Args:
        entity_id: ID of the entity
        flag: Flag value to remove
        level: Level of flag
        author: Who is removing the flag
        reason: Optional reason for removal
    
    Returns:
        bool: True if flag was removed
    """
    removed = False
    
    if level == "snip":
        embryo_id = self._get_embryo_id_from_snip(entity_id)
        if embryo_id:
            snip_data = self.data["embryos"][embryo_id]["snips"].get(entity_id, {})
            flags = snip_data.get("flags", [])
            
            for i, flag_data in enumerate(flags):
                if flag_data["value"] == flag:
                    removed_flag = flags.pop(i)
                    removed = True
                    break
    
    elif level in ["image", "video", "experiment"]:
        flags_data = self.data["flags"].get(level, {}).get(entity_id, [])
        
        for i, flag_data in enumerate(flags_data):
            if flag_data["value"] == flag:
                removed_flag = flags_data.pop(i)
                removed = True
                break
    
    if removed:
        self._unsaved_changes = True
        self._add_change_log("remove_flag", {
            "level": level,
            "entity_id": entity_id,
            "flag": flag,
            "author": author,
            "reason": reason
        })
        
        if self.verbose:
            print(f"âœ… Removed flag '{flag}' from {level} {entity_id}")
    else:
        if self.verbose:
            print(f"âš ï¸ Flag '{flag}' not found on {level} {entity_id}")
    
    return removed
```

## Batch Flag Operations

### Batch Add Flags

```python
def batch_add_flags(self, flags_data: Dict, level: str, author: str,
                   auto_generated: bool = False) -> Dict:
    """
    Batch add flags to multiple entities.
    
    Args:
        flags_data: Dict mapping entity_id to flag(s)
            Examples:
            - {"entity1": "FLAG1", "entity2": ["FLAG1", "FLAG2"]}
            - {"entity1": [{"value": "FLAG1", "notes": "..."}]}
        level: Level for all flags
        author: Author for all flags
        auto_generated: Whether flags are auto-generated
    
    Returns:
        Results dictionary
    """
    results = {
        "added": [],
        "skipped": [],
        "failed": []
    }
    
    total = len(flags_data)
    if self.verbose:
        print(f"ðŸ”„ Batch adding flags to {total} {level}s...")
    
    for i, (entity_id, flag_spec) in enumerate(flags_data.items()):
        # Parse flag specification
        if isinstance(flag_spec, str):
            # Single flag
            flags_to_add = [flag_spec]
        elif isinstance(flag_spec, list):
            flags_to_add = []
            for item in flag_spec:
                if isinstance(item, str):
                    flags_to_add.append(item)
                elif isinstance(item, dict):
                    flags_to_add.append(item)
        else:
            results["failed"].append((entity_id, "Invalid flag specification"))
            continue
        
        # Add each flag
        entity_added = False
        for flag_item in flags_to_add:
            try:
                if isinstance(flag_item, str):
                    success = self.add_flag(
                        entity_id, flag_item, level, author,
                        auto_generated=auto_generated
                    )
                else:
                    # Dict with detailed info
                    success = self.add_flag(
                        entity_id, 
                        flag_item["value"], 
                        level, 
                        author,
                        notes=flag_item.get("notes"),
                        severity=flag_item.get("severity", "warning"),
                        auto_generated=auto_generated
                    )
                
                if success:
                    entity_added = True
                    
            except Exception as e:
                results["failed"].append((entity_id, str(e)))
        
        if entity_added:
            results["added"].append(entity_id)
        else:
            results["skipped"].append(entity_id)
        
        # Progress indicator
        if self.verbose and (i + 1) % 100 == 0:
            print(f"   Processed {i + 1}/{total}...")
    
    # Summary
    if self.verbose:
        print(f"âœ… Results:")
        print(f"   Added: {len(results['added'])}")
        print(f"   Skipped: {len(results['skipped'])}")
        print(f"   Failed: {len(results['failed'])}")
    
    return results
```

### Automated Flag Detection

```python
def auto_detect_flags(self, flag_detectors: Dict[str, callable], 
                     author: str = "auto_detector") -> Dict:
    """
    Run automated flag detection across the dataset.
    
    Args:
        flag_detectors: Dict of detector functions by level
            Example: {
                "snip": [detect_motion_blur, detect_mask_variance],
                "image": [detect_missing_embryos],
                "video": [detect_nonzero_seed]
            }
        author: Author for auto-detected flags
    
    Returns:
        Detection results
    """
    results = {
        "total_flags_added": 0,
        "by_level": {}
    }
    
    # Run snip-level detectors
    if "snip" in flag_detectors:
        snip_results = self._run_snip_detectors(
            flag_detectors["snip"], author
        )
        results["by_level"]["snip"] = snip_results
        results["total_flags_added"] += snip_results["added"]
    
    # Run image-level detectors
    if "image" in flag_detectors:
        image_results = self._run_image_detectors(
            flag_detectors["image"], author
        )
        results["by_level"]["image"] = image_results
        results["total_flags_added"] += image_results["added"]
    
    # Run video-level detectors
    if "video" in flag_detectors:
        video_results = self._run_video_detectors(
            flag_detectors["video"], author
        )
        results["by_level"]["video"] = video_results
        results["total_flags_added"] += video_results["added"]
    
    # Run experiment-level detectors
    if "experiment" in flag_detectors:
        exp_results = self._run_experiment_detectors(
            flag_detectors["experiment"], author
        )
        results["by_level"]["experiment"] = exp_results
        results["total_flags_added"] += exp_results["added"]
    
    if self.verbose:
        print(f"\nðŸ” Auto-detection complete!")
        print(f"Total flags added: {results['total_flags_added']}")
    
    return results

def _run_snip_detectors(self, detectors: List[callable], author: str) -> Dict:
    """Run detectors on all snips."""
    results = {"added": 0, "detections": []}
    
    for embryo_id, embryo_data in self.data["embryos"].items():
        for snip_id, snip_data in embryo_data["snips"].items():
            for detector in detectors:
                try:
                    # Run detector
                    detection = detector(snip_id, snip_data, self)
                    
                    if detection:
                        flag_value = detection["flag"]
                        notes = detection.get("notes", "")
                        severity = detection.get("severity", "warning")
                        
                        success = self.add_flag(
                            snip_id, flag_value, "snip", author,
                            notes=notes, severity=severity,
                            auto_generated=True
                        )
                        
                        if success:
                            results["added"] += 1
                            results["detections"].append({
                                "snip_id": snip_id,
                                "flag": flag_value,
                                "detector": detector.__name__
                            })
                            
                except Exception as e:
                    if self.verbose:
                        print(f"âš ï¸ Detector {detector.__name__} failed on {snip_id}: {e}")
    
    return results
```

## Flag Queries and Analysis

### Get Flags for Entity

```python
def get_flags(self, entity_id: str, level: str = None) -> List[Dict]:
    """
    Get all flags for an entity.
    
    Args:
        entity_id: Entity identifier
        level: Optional level hint for faster lookup
    
    Returns:
        List of flag dictionaries
    """
    flags = []
    
    # If level not specified, try to infer from ID format
    if not level:
        level = self._infer_level_from_id(entity_id)
    
    if level == "snip":
        embryo_id = self._get_embryo_id_from_snip(entity_id)
        if embryo_id:
            snip_data = self.data["embryos"][embryo_id]["snips"].get(entity_id, {})
            flags = snip_data.get("flags", [])
    
    elif level in ["image", "video", "experiment"]:
        flags = self.data["flags"].get(level, {}).get(entity_id, [])
    
    else:
        # Try all levels
        for check_level in ["snip", "image", "video", "experiment"]:
            level_flags = self.get_flags(entity_id, level=check_level)
            if level_flags:
                flags = level_flags
                break
    
    return flags

def get_entities_with_flag(self, flag: str, level: str = None) -> List[str]:
    """
    Find all entities with a specific flag.
    
    Args:
        flag: Flag value to search for
        level: Optional level filter
    
    Returns:
        List of entity IDs
    """
    entities = []
    levels_to_check = [level] if level else ["snip", "image", "video", "experiment"]
    
    for check_level in levels_to_check:
        if check_level == "snip":
            # Check snip flags
            for embryo_data in self.data["embryos"].values():
                for snip_id, snip_data in embryo_data["snips"].items():
                    flags = snip_data.get("flags", [])
                    if any(f["value"] == flag for f in flags):
                        entities.append(snip_id)
        
        elif check_level in ["image", "video", "experiment"]:
            # Check other level flags
            level_data = self.data["flags"].get(check_level, {})
            for entity_id, flags in level_data.items():
                if any(f["value"] == flag for f in flags):
                    entities.append(entity_id)
    
    return entities
```

### Flag Statistics

```python
def get_flag_statistics(self, by_severity: bool = True) -> Dict:
    """
    Calculate flag statistics across all levels.
    
    Args:
        by_severity: Group by severity levels
    
    Returns:
        Statistics dictionary
    """
    stats = {
        "total_flags": 0,
        "by_level": {
            "snip": 0,
            "image": 0,
            "video": 0,
            "experiment": 0
        },
        "by_flag": defaultdict(int),
        "by_author": defaultdict(int),
        "auto_generated": 0,
        "manual": 0
    }
    
    if by_severity:
        stats["by_severity"] = {
            "info": 0,
            "warning": 0,
            "error": 0
        }
    
    # Count snip flags
    for embryo_data in self.data["embryos"].values():
        for snip_data in embryo_data["snips"].values():
            flags = snip_data.get("flags", [])
            for flag in flags:
                stats["total_flags"] += 1
                stats["by_level"]["snip"] += 1
                stats["by_flag"][flag["value"]] += 1
                stats["by_author"][flag["author"]] += 1
                
                if flag.get("auto_generated", False):
                    stats["auto_generated"] += 1
                else:
                    stats["manual"] += 1
                
                if by_severity:
                    severity = flag.get("severity", "warning")
                    stats["by_severity"][severity] += 1
    
    # Count other level flags
    for level in ["image", "video", "experiment"]:
        level_data = self.data["flags"].get(level, {})
        for entity_flags in level_data.values():
            for flag in entity_flags:
                stats["total_flags"] += 1
                stats["by_level"][level] += 1
                stats["by_flag"][flag["value"]] += 1
                stats["by_author"][flag["author"]] += 1
                
                if flag.get("auto_generated", False):
                    stats["auto_generated"] += 1
                else:
                    stats["manual"] += 1
                
                if by_severity:
                    severity = flag.get("severity", "warning")
                    stats["by_severity"][severity] += 1
    
    # Convert defaultdicts
    stats["by_flag"] = dict(stats["by_flag"])
    stats["by_author"] = dict(stats["by_author"])
    
    return stats
```

## Flag Export

```python
def export_flags(self, output_path: Path, format: str = "csv",
                include_empty: bool = False) -> None:
    """
    Export all flags for analysis.
    
    Args:
        output_path: Output file path
        format: Export format ("csv", "json", "tsv")
        include_empty: Include entities without flags
    """
    if format == "csv":
        self._export_flags_csv(output_path, include_empty)
    elif format == "json":
        self._export_flags_json(output_path, include_empty)
    elif format == "tsv":
        self._export_flags_tsv(output_path, include_empty)
    else:
        raise ValueError(f"Unknown export format: {format}")

def _export_flags_csv(self, output_path: Path, include_empty: bool) -> None:
    """Export flags to CSV format."""
    import csv
    
    rows = []
    
    # Export snip flags
    for embryo_id, embryo_data in self.data["embryos"].items():
        for snip_id, snip_data in embryo_data["snips"].items():
            flags = snip_data.get("flags", [])
            
            if flags or include_empty:
                if flags:
                    for flag in flags:
                        rows.append({
                            "level": "snip",
                            "entity_id": snip_id,
                            "embryo_id": embryo_id,
                            "flag": flag["value"],
                            "severity": flag.get("severity", "warning"),
                            "author": flag["author"],
                            "timestamp": flag["timestamp"],
                            "auto_generated": flag.get("auto_generated", False),
                            "notes": flag.get("notes", "")
                        })
                else:
                    rows.append({
                        "level": "snip",
                        "entity_id": snip_id,
                        "embryo_id": embryo_id,
                        "flag": "",
                        "severity": "",
                        "author": "",
                        "timestamp": "",
                        "auto_generated": "",
                        "notes": "NO FLAGS"
                    })
    
    # Export other level flags
    for level in ["image", "video", "experiment"]:
        level_data = self.data["flags"].get(level, {})
        
        for entity_id, flags in level_data.items():
            if flags or include_empty:
                if flags:
                    for flag in flags:
                        rows.append({
                            "level": level,
                            "entity_id": entity_id,
                            "embryo_id": "",
                            "flag": flag["value"],
                            "severity": flag.get("severity", "warning"),
                            "author": flag["author"],
                            "timestamp": flag["timestamp"],
                            "auto_generated": flag.get("auto_generated", False),
                            "notes": flag.get("notes", "")
                        })
                else:
                    rows.append({
                        "level": level,
                        "entity_id": entity_id,
                        "embryo_id": "",
                        "flag": "",
                        "severity": "",
                        "author": "",
                        "timestamp": "",
                        "auto_generated": "",
                        "notes": "NO FLAGS"
                    })
    
    # Write CSV
    with open(output_path, 'w', newline='') as f:
        if rows:
            writer = csv.DictWriter(f, fieldnames=rows[0].keys())
            writer.writeheader()
            writer.writerows(rows)
    
    if self.verbose:
        print(f"ðŸ“Š Exported {len(rows)} flag records to {output_path}")
```

## Helper Methods

```python
def _infer_level_from_id(self, entity_id: str) -> Optional[str]:
    """Infer entity level from ID format."""
    parts = entity_id.split('_')
    
    # Patterns:
    # experiment: YYYYMMDD
    # video: YYYYMMDD_WELL
    # image: YYYYMMDD_WELL_FRAME
    # snip: YYYYMMDD_WELL_eNN_FRAME
    
    if len(parts) == 1 and len(parts[0]) == 8 and parts[0].isdigit():
        return "experiment"
    elif len(parts) == 2:
        return "video"
    elif len(parts) == 3:
        return "image"
    elif len(parts) == 4 and parts[2].startswith('e'):
        return "snip"
    
    return None

def _add_embryo_flag(self, embryo_id: str, flag: str, author: str, 
                    notes: str = None) -> None:
    """Add a special embryo-level flag (stored with embryo)."""
    if embryo_id not in self.data["embryos"]:
        raise ValueError(f"Embryo {embryo_id} not found")
    
    embryo_data = self.data["embryos"][embryo_id]
    
    if "embryo_flags" not in embryo_data:
        embryo_data["embryo_flags"] = []
    
    flag_obj = Flag(
        value=flag,
        author=author,
        notes=notes
    )
    
    embryo_data["embryo_flags"].append(flag_obj.to_dict())
    self._unsaved_changes = True
```